# Stata Metadata Sync Workflow Review

**File**: [unicefdata_sync.ado](stata/src/u/unicefdata_sync.ado)
**Review Date**: 2026-01-24
**Purpose**: Verify all subroutines generate YAML files in `stata/src/_/`

---

## Executive Summary

✅ **Path Detection**: Correct - auto-detects `stata/src/_/` directory
✅ **All Subroutines**: Verified - all write to correct output location
✅ **Output Files**: 9 YAML files + dataflow schemas in `__dataflows/` subfolder
✅ **Architecture**: Modular design with 7 specialized sync subroutines

---

## Path Detection Logic

**Location**: Lines 228-251

The main program auto-detects the metadata directory in three stages:

1. **Primary**: Find `_unicef_list_dataflows.ado` → extract directory path
2. **Fallback 1**: Find `unicefdata.ado` → navigate to `src/_/` subdirectory
3. **Fallback 2**: Use Stata PLUS directory `c(sysdir_plus)_/`

**Result**: Variable `path` contains the metadata directory (typically `C:\GitHub\myados\unicefData-dev\stata\src\_\`)

**Critical Code** (line 259):
```stata
local current_dir "`path'"
```

All subroutines receive `current_dir` via `OUTFILE` or `OUTDIR` parameters.

---

## Output Files Generated

### Core YAML Files (9 files in `stata/src/_/`)

| File | Purpose | Subroutine | Line |
|------|---------|------------|------|
| `_unicefdata_dataflows.yaml` | Dataflow catalog | `_unicefdata_sync_dataflows` | 300 |
| `_unicefdata_indicators.yaml` | Indicator catalog | `_unicefdata_sync_indicators` | 435 |
| `_unicefdata_codelists.yaml` | Age/Wealth/Residence codes | `_unicefdata_sync_codelists` | 333 |
| `_unicefdata_countries.yaml` | Country codelist | `_unicefdata_sync_cl_single` | 365 |
| `_unicefdata_regions.yaml` | Region codelist | `_unicefdata_sync_cl_single` | 400 |
| `_unicefdata_sync_history.yaml` | Sync history log | `_unicefdata_update_sync_history` | 574 |
| `_unicefdata_indicators_metadata.yaml` | Full indicator metadata | `_unicefdata_sync_ind_meta` | 510 |
| `_dataflow_index.yaml` | Dataflow schema index | `_unicefdata_sync_dataflow_index` | 469 |
| `_dataflow_fallback_sequences.yaml` | Fallback dataflow sequences | _(conditional)_ | 523 |

### Dataflow Schema Files (`stata/src/_/__dataflows/`)

Individual YAML files for each dataflow:
- `__dataflows/CME.yaml`
- `__dataflows/GLOBAL_DATAFLOW.yaml`
- ...69 total files (one per dataflow)

Generated by: `_unicefdata_sync_df_schema` (called from `_unicefdata_sync_dataflow_index`)

### Vintage Snapshots (`stata/src/_/vintages/YYYYMMDD/`)

Dated copies of all metadata files for historical tracking (lines 543-568).

---

## Subroutine Analysis

### 1. `_unicefdata_sync_dataflows` (lines 695-910)

**Purpose**: Download and parse dataflow catalog from SDMX API

**Input Parameters**:
- `URL`: API endpoint for dataflows
- `OUTFILE`: Output YAML file path
- `VERSION`: Package version
- `AGENCY`: Agency code (UNICEF)

**Key Features**:
- Supports both Python and Stata parsers
- Uses `filefilter` to split XML into parseable lines
- Extracts: dataflow ID, version, name, description
- Writes YAML with metadata watermark

**Output**: `_unicefdata_dataflows.yaml` at `OUTFILE` location

**Verification**: ✅ Writes to `current_dir` (passed as OUTFILE)

---

### 2. `_unicefdata_sync_codelists` (lines 917-1037)

**Purpose**: Fetch and parse multiple codelists with code values

**Codelists Fetched**:
- `CL_AGE`
- `CL_WEALTH_QUINTILE`
- `CL_RESIDENCE`
- `CL_UNIT_MEASURE`
- `CL_OBS_STATUS`

**Input Parameters**:
- `BASEURL`: SDMX API base URL
- `OUTFILE`: Output YAML file path
- `VERSION`: Package version
- `AGENCY`: Agency code

**Key Features**:
- Two-pass processing: first count codes, then extract details
- Line-by-line XML parsing with `filefilter`
- Writes code:name mappings in YAML format

**Output**: `_unicefdata_codelists.yaml` at `OUTFILE` location

**Verification**: ✅ Writes to `current_dir` (passed as OUTFILE)

---

### 3. `_unicefdata_sync_cl_single` (lines 1044-1225)

**Purpose**: Sync individual codelist (used for countries and regions)

**Called Twice**:
1. **Countries** (line 365):
   - Codelist: `CL_GEO_AREA`
   - Output: `_unicefdata_countries.yaml`

2. **Regions** (line 400):
   - Codelist: `CL_GEO_REGIONAL_GROUPS`
   - Output: `_unicefdata_regions.yaml`

**Input Parameters**:
- `URL`: Codelist API endpoint
- `OUTFILE`: Output YAML file path
- `CONTENTTYPE`: "countries" or "regions"
- `CODELISTID`: SDMX codelist ID
- `AGENCY`, `VERSION`: Metadata

**Key Features**:
- Python parser support via `forcepython` option
- Stata parser fallback with `filefilter` preprocessing
- Extracts codelist name from XML metadata
- Writes watermark with codelist details

**Output**: YAML file at `OUTFILE` location

**Verification**: ✅ Writes to `current_dir` (passed as OUTFILE)

---

### 4. `_unicefdata_sync_indicators` (lines 1231-1274)

**Purpose**: Sync indicator catalog from SDMX codelist

**API Endpoint**: `CL_UNICEF_INDICATOR` codelist

**Input Parameters**:
- `OUTFILE`: Output YAML file path
- `VERSION`, `AGENCY`: Metadata
- `FORCEPYTHON`/`FORCESTATA`: Parser selection

**Key Features**:
- Delegates to `unicefdata_xmltoyaml` helper program
- Supports both Python and Stata parsers
- Returns count of synced indicators

**Output**: `_unicefdata_indicators.yaml` at `OUTFILE` location

**Verification**: ✅ Writes to `current_dir` (passed as OUTFILE)

---

### 5. `_unicefdata_sync_dataflow_index` (lines 1284-1586)

**Purpose**: Sync all dataflow schemas with dimension/attribute counts

**Output Files**:
1. **Index**: `_dataflow_index.yaml` (summary of all dataflows)
2. **Schemas**: `__dataflows/{DATAFLOW_ID}.yaml` (one per dataflow)

**Input Parameters**:
- `OUTDIR`: Output directory path
- `AGENCY`: Agency code
- `SUFFIX`: Optional filename suffix
- `FORCEPYTHON`/`FORCESTATA`: Parser selection

**Key Features**:
- **Auto-detects Python** (preferred due to Stata macro limits)
- Calls `stata_schema_sync.py` for Python processing
- Stata fallback parsing (limited to smaller datasets)
- Creates `__dataflows/` subfolder for individual schemas
- Rate limiting (200ms delay between API calls)

**Python Script**: `stata/src/py/stata_schema_sync.py`

**Dataflow Schema Details** (via `_unicefdata_sync_df_schema`, lines 1592-1726):
- Dimension list with positions and codelists
- Attribute list
- Time dimension (`TIME_PERIOD`)
- Primary measure (`OBS_VALUE`)

**Output**:
- `_dataflow_index.yaml` at `OUTDIR`
- 69 schema files in `OUTDIR/__dataflows/`

**Verification**: ✅ Writes to `current_dir` (passed as OUTDIR)

---

### 6. `_unicefdata_sync_ind_meta` (lines 1730-1879)

**Purpose**: Sync full indicator metadata with enrichments

**Critical Features**:

#### Staleness Check (lines 1743-1807)
- 30-day cache threshold
- Parses `synced_at` or `last_updated` timestamp from existing file
- Skips sync if file age < 30 days (unless `FORCE` specified)

#### API Call
- Fetches `CL_UNICEF_INDICATOR` codelist
- Delegates to `unicefdata_xmltoyaml` helper

#### Parser Selection (lines 1829-1840)
- **Default**: `forcepython` (robust for large XML)
- **Optional**: `forcestata` (limited to ~730 indicators due to macro limits)

#### Enrichment Options
- `ENRICHDATAFLOWS`: Add dataflow mappings to each indicator
- `FALLBACKSEQUENCESOUT`: Generate fallback dataflow sequences file

**Input Parameters**:
- `OUTFILE`: Output YAML file path
- `AGENCY`: Agency code
- `FORCE`: Skip staleness check
- `ENRICHDATAFLOWS`: Enable dataflow mapping enrichment
- `FALLBACKSEQUENCESOUT`: Output path for fallback sequences

**Output**:
- `_unicefdata_indicators_metadata.yaml` at `OUTFILE`
- Optional: `_dataflow_fallback_sequences.yaml` at `FALLBACKSEQUENCESOUT`

**Verification**: ✅ Writes to `current_dir` (passed as OUTFILE and FALLBACKSEQUENCESOUT)

---

### 7. `_unicefdata_update_sync_history` (lines 1885-1905)

**Purpose**: Update sync history log with latest run details

**Input Parameters**:
- `FILEPATH`: Sync history file path
- `VINTAGEDATE`: Snapshot date (YYYYMMDD)
- `SYNCEDAT`: Timestamp
- Count parameters: `DATAFLOWS`, `INDICATORS`, `CODELISTS`, `COUNTRIES`, `REGIONS`

**Key Features**:
- Writes simplified history (doesn't preserve old entries)
- Records counts for all synced metadata types
- Empty errors array

**Output**: `_unicefdata_sync_history.yaml` at `FILEPATH`

**Verification**: ✅ Writes to `current_dir` (passed as FILEPATH)

**Note**: Current implementation replaces history file on each sync. Enhancement opportunity: append new vintages instead of replacing.

---

## Helper Programs Called

### `unicefdata_xmltoyaml`

**File**: [unicefdata_xmltoyaml.ado](stata/src/u/unicefdata_xmltoyaml.ado)
**Purpose**: Generic XML to YAML converter with Python fallback

**Called By**:
- `_unicefdata_sync_cl_single` (countries/regions)
- `_unicefdata_sync_indicators` (indicator catalog)
- `_unicefdata_sync_ind_meta` (full indicator metadata)

**Parser Options**:
- `forcepython`: Use Python script ([unicefdata_xml2yaml.py](stata/src/py/unicefdata_xml2yaml.py))
- `forcestata`: Use pure Stata parsing (limited by macro length)
- _(default)_: Auto-detect Python, fallback to Stata

**Enrichment Support**:
- `enrichdataflows`: Add dataflow mappings using [enrich_stata_metadata_complete.py](stata/src/py/enrich_stata_metadata_complete.py)
- `fallbacksequencesout`: Generate fallback dataflow sequences

### Python Helper Scripts

#### `stata_schema_sync.py` (called by `_unicefdata_sync_dataflow_index`)
**Location**: [stata/src/py/stata_schema_sync.py](stata/src/py/stata_schema_sync.py)
**Purpose**: Fetch and parse dataflow schemas (DSD) for all 69 dataflows

#### `unicefdata_xml2yaml.py` (called by `unicefdata_xmltoyaml`)
**Location**: [stata/src/py/unicefdata_xml2yaml.py](stata/src/py/unicefdata_xml2yaml.py)
**Purpose**: Parse SDMX XML to YAML with Python's superior string handling

#### `enrich_stata_metadata_complete.py` (called by `unicefdata_xmltoyaml`)
**Location**: [stata/src/py/enrich_stata_metadata_complete.py](stata/src/py/enrich_stata_metadata_complete.py)
**Purpose**: Enrich indicator metadata with dataflow mappings and disaggregations

---

## Design Choices

### 1. Parser Architecture: Stata vs Python

**Python Parser**:
- ✅ No macro length limits (handles 900+ indicators)
- ✅ Full XML parsing with `xml.etree.ElementTree`
- ✅ Robust string handling
- ❌ Requires Python 3.6+ installed
- ❌ External dependency

**Stata Parser**:
- ✅ No external dependencies
- ✅ Portable across Stata installations
- ❌ Limited to ~730 indicators (macro length limit)
- ❌ Line-by-line parsing with `filefilter` preprocessing

**Decision**: Default to Python (auto-detected), fallback to Stata if unavailable

### 2. Line-by-Line XML Processing (Stata Parser)

SDMX API returns XML as single line. Stata's `file read` requires newlines.

**Solution**: `filefilter` preprocessing to split XML at element boundaries

Example (line 746):
```stata
filefilter "`xmlfile'" "`txtfile'", from("<str:Dataflow") to("\n<str:Dataflow") replace
```

This enables line-by-line iteration:
```stata
file open `infh' using "`txtfile'", read
file read `infh' line
while !r(eof) {
    if (strmatch(`"`line'"', "*<str:Dataflow *id=*") == 1) {
        * Parse line...
    }
    file read `infh' line
}
```

### 3. Metadata Watermark

All YAML files include standardized metadata header:
```yaml
_metadata:
  platform: Stata
  version: '1.5.2'
  synced_at: '2026-01-24T12:34:56Z'
  source: https://sdmx.data.unicef.org/...
  agency: UNICEF
  content_type: dataflows
  total_dataflows: 69
```

**Purpose**: Cross-platform consistency check (Python/R/Stata)

### 4. Staleness Check (30-Day Cache)

**Location**: `_unicefdata_sync_ind_meta` (lines 1743-1807)

**Logic**:
1. Check if output file exists
2. Extract `synced_at` or `last_updated` timestamp from YAML
3. Calculate file age in days
4. Skip sync if age < 30 days

**Override**: Use `force` option to bypass cache

**Rationale**: Reduce API load for large metadata files (900+ indicators)

### 5. Vintage Snapshots

**Location**: Lines 543-568

**Purpose**: Historical archiving of metadata

**Directory Structure**:
```
stata/src/_/vintages/
  20260124/
    _unicefdata_dataflows.yaml
    _unicefdata_indicators.yaml
    _unicefdata_codelists.yaml
    _unicefdata_countries.yaml
    _unicefdata_regions.yaml
```

**Use Case**: Compare metadata changes over time, rollback to previous version

---

## Workflow Summary

### Full Sync Command
```stata
unicefdata_sync, verbose
```

### Execution Flow

1. **Auto-detect metadata directory** → `current_dir = stata/src/_/`
2. **Sync dataflows** → `_unicefdata_dataflows.yaml`
3. **Sync codelists** → `_unicefdata_codelists.yaml`
4. **Sync countries** → `_unicefdata_countries.yaml`
5. **Sync regions** → `_unicefdata_regions.yaml`
6. **Sync indicators** → `_unicefdata_indicators.yaml`
7. **Sync dataflow schemas** → `_dataflow_index.yaml` + `__dataflows/*.yaml`
8. **Sync indicator metadata** → `_unicefdata_indicators_metadata.yaml`
9. **Create vintage snapshot** → `vintages/YYYYMMDD/`
10. **Update sync history** → `_unicefdata_sync_history.yaml`

### Selective Sync Options

Sync specific metadata types:
```stata
unicefdata_sync, dataflows verbose
unicefdata_sync, indicators verbose
unicefdata_sync, codelists countries regions verbose
```

### Enrichment Options

```stata
* Enable dataflow mapping enrichment
unicefdata_sync, enrichdataflows verbose

* Generate fallback sequences file
unicefdata_sync, fallbacksequences verbose
```

### Parser Override

```stata
* Force Python parser (recommended for large files)
unicefdata_sync, forcepython verbose

* Force Stata parser (portable but limited)
unicefdata_sync, forcestata verbose
```

---

## Path Verification Test

### Test Command
```stata
unicefdata_sync, verbose
```

### Expected Output Location
```
C:\GitHub\myados\unicefData-dev\stata\src\_\
  _unicefdata_dataflows.yaml
  _unicefdata_indicators.yaml
  _unicefdata_codelists.yaml
  _unicefdata_countries.yaml
  _unicefdata_regions.yaml
  _unicefdata_sync_history.yaml
  _unicefdata_indicators_metadata.yaml
  _dataflow_index.yaml
  _dataflow_fallback_sequences.yaml
  __dataflows/
    CME.yaml
    GLOBAL_DATAFLOW.yaml
    ... (69 files)
  vintages/
    20260124/
      _unicefdata_dataflows.yaml
      ...
```

---

## Verification Results

### Subroutine Output Path Check

| Subroutine | Output Parameter | Receives `current_dir`? | Writes to `stata/src/_/`? |
|------------|------------------|-------------------------|---------------------------|
| `_unicefdata_sync_dataflows` | `OUTFILE` | ✅ Yes (line 300) | ✅ Yes |
| `_unicefdata_sync_codelists` | `OUTFILE` | ✅ Yes (line 333) | ✅ Yes |
| `_unicefdata_sync_cl_single` (countries) | `OUTFILE` | ✅ Yes (line 365) | ✅ Yes |
| `_unicefdata_sync_cl_single` (regions) | `OUTFILE` | ✅ Yes (line 400) | ✅ Yes |
| `_unicefdata_sync_indicators` | `OUTFILE` | ✅ Yes (line 435) | ✅ Yes |
| `_unicefdata_sync_dataflow_index` | `OUTDIR` | ✅ Yes (line 469) | ✅ Yes |
| `_unicefdata_sync_ind_meta` | `OUTFILE` | ✅ Yes (line 510) | ✅ Yes |
| `_unicefdata_update_sync_history` | `FILEPATH` | ✅ Yes (line 574) | ✅ Yes |

### Path Detection Logic Check

```stata
* Primary detection (lines 230-238)
capture findfile _unicef_list_dataflows.ado
if (_rc == 0) {
    local ado_path "`r(fn)'"                     * Full path to ado file
    local ado_dir = subinstr("`ado_path'", "\", "/", .)
    local ado_dir = subinstr("`ado_dir'", "_unicef_list_dataflows.ado", "", .)
    local path "`ado_dir'"                       * Result: stata/src/_/
}
```

✅ **Verified**: Correctly extracts directory from ado file path

### Critical Confirmation

**Line 259**: All output paths derive from auto-detected `path`
```stata
local current_dir "`path'"
```

**Lines 300-574**: All subroutine calls pass `current_dir` as output location

**Conclusion**: ✅ **All YAML files will be generated in `stata/src/_/` directory**

---

## Test Run Recommendation

Execute dry run to confirm:
```stata
cd C:\GitHub\myados\unicefData-dev
unicefdata_sync, dataflows verbose
```

This will:
1. Auto-detect path as `C:\GitHub\myados\unicefData-dev\stata\src\_\`
2. Sync only dataflows (fastest test)
3. Generate `_unicefdata_dataflows.yaml` in correct location
4. Display verbose output showing file path

After confirming dataflows work, run full sync:
```stata
unicefdata_sync, verbose
```

---

## Summary

✅ **Path Detection**: Robust auto-detection with fallbacks
✅ **Output Locations**: All subroutines write to `current_dir` = `stata/src/_/`
✅ **Architecture**: Modular, well-documented subroutines
✅ **Parser Strategy**: Python-first with Stata fallback
✅ **Cross-Platform**: YAML watermarks enable consistency checks
✅ **Caching**: 30-day staleness check reduces API load
✅ **Versioning**: Vintage snapshots for historical tracking

**Recommendation**: Ready for test run. No path issues detected.

---

**Review Completed**: 2026-01-24
**Reviewer**: Claude Sonnet 4.5
**Files Analyzed**: 1 (1906 lines)
**Subroutines Verified**: 8 (7 sync + 1 helper)
**Output Files**: 9 YAML + 69 dataflow schemas
