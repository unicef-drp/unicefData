}
#----------------------------------------
# Load User Config (YAML Required)
#----------------------------------------
config_path <- file.path(USERPROFILE, ".config", "user_config.yml")
# Ensure YAML package is available
if (!requireNamespace("yaml", quietly = TRUE)) install.packages("yaml")
library(yaml)
# Check if config file exists
if (!file.exists(config_path)) {
stop(paste0(
"‚ùå Configuration file not found at expected path: ", config_path, "\n",
"üëâ Please create or move your 'user_config.yml' to this location.\n",
"A template is available in the GitHub repository under: '_config_template/user_config.yml'"
))
}
# Read config
config_yaml <- yaml::read_yaml(config_path)
# Validate user entry
if (!USERNAME %in% names(config_yaml)) {
stop(paste0(
"‚ùå Configuration file found at: ", config_path, ",\n",
"but no entry found for user: '", USERNAME, "'.\n",
"üëâ Please ensure your username is correctly defined in the YAML file.\n",
"A template is available in the GitHub repo under: '_config_template/user_config.yml'."
))
}
# Load user-specific paths
githubFolder <- config_yaml[[USERNAME]]$githubFolder
teamsRoot    <- config_yaml[[USERNAME]]$teamsRoot
# Confirm successful load
message(paste0("‚úÖ Loaded user configuration for '", USERNAME, "' from: ", config_path))
# Define full paths using repo_name
projectFolder <- file.path(githubFolder, repo_name)
# Check that the last folder in githubFolder matches the repo name
actual_repo_folder <- basename(normalizePath(projectFolder, winslash = "/", mustWork = FALSE))
if (!identical(actual_repo_folder, repo_name)) {
stop(sprintf("‚ùå The repo_name '%s' does not match the actual folder name '%s' in githubFolder.", repo_name, actual_repo_folder))
}
teamsFolder   <- file.path(teamsRoot, "022.SDG-Report-2025")
#----------------------------------------
# Directory Structure
# üìÅ Documentation
doc         <- file.path(projectFolder, "00_documentation")
docInput    <- file.path(doc, "01_input_data")
docProc     <- file.path(doc, "02_processed_data")
# üìÅ Input Data
metaData        <- file.path(projectFolder, "01_data_prep/011_rawdata/hosted_in_repo")
metaDataUpdate  <- file.path(projectFolder, "01_data_prep/011_rawdata/")
targetData      <- file.path(projectFolder, "01_data_prep/011_rawdata/hosted_in_repo")
rawData         <- file.path(projectFolder, "01_data_prep/011_rawdata/")
procData        <- file.path(projectFolder, "01_data_prep/013_wrkdata/")
# üìÅ Functions
rFunc       <- file.path(projectFolder, "99_functions")
# üìÅ Teams
teamsFigures <- file.path(teamsFolder, "figures")
# üìÅ Data Analysis and Visualization
dataAnalytics        <- file.path(projectFolder, "03_data_analytics")
dataVizFigures       <- file.path(dataAnalytics, "033_results/figures")
# üìÅ Country Briefs
countryBriefs    <- file.path(projectFolder, "04_country_briefs")
GraphFolder      <- file.path(countryBriefs, "043_interim_output/graphs")
TemplateFolder   <- file.path(countryBriefs, "042_codes/md_template")
IntOutputFolder  <- file.path(countryBriefs, "043_interim_output/raw_output")
project_dirs <- c(doc, docInput, docProc, rFunc, metaData, targetData, rawData, procData, metaDataUpdate,
dataAnalytics, dataVizFigures, countryBriefs)
teams_dirs   <- c(teamsFigures)
required_dirs <- c(project_dirs, teams_dirs)
for (dir in required_dirs) {
if (!dir.exists(dir)) {
if (create_missing_folders) {
message(sprintf("üìÅ Creating missing folder: %s", dir))
dir.create(dir, recursive = TRUE)
} else {
stop(sprintf("‚ùå Required folder not found: %s. Set create_missing_folders <- TRUE to auto-create.", dir))
}
}
}
#----------------------------------------
# Environment Health Check
#----------------------------------------
check_env <- function() {
message("üîç Environment Check:")
message("- User: ", USERNAME)
message("- Project folder exists: ", dir.exists(projectFolder))
message("- Output folder writeable: ", file.access(procData, 2) == 0)
message("- Network drive available: ", dir.exists(network_root))
message("- R version: ", getRversion())
}
check_env()
#----------------------------------------
# Package Handling
#----------------------------------------
required_packages <- c(
"readr", "tidyverse", "data.table", "countrycode", "wesanderson",
"readxl", "openxlsx", "ggcorrplot", "gridExtra", "utf8", "haven",
"plotly", "mgcv", "DT", "sass", "devtools", "Rilostat", "wbstats",
"zoo", "cowplot", "MatchIt", "GGally", "COINr"
)
check_and_install_packages <- function(packages) {
install_type <- ifelse(.Platform$OS.type == "windows", "binary", "source")
for (pkg in unique(packages)) {
if (!requireNamespace(pkg, quietly = TRUE)) {
message(sprintf("üì¶ Installing missing package: %s", pkg))
install.packages(pkg, type = install_type)
}
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}
}
check_and_install_packages(required_packages)
message("‚úÖ All required libraries were loaded successfully.")
#----------------------------------------
# Source Utility Functions
#----------------------------------------
if (dir.exists(rFunc)) {
r_func_files <- list.files(path = rFunc, pattern = "\\.R$", full.names = TRUE)
for (file in r_func_files) {
cat("üîÑ Sourcing:", file, "\n")
tryCatch({
source(file)
}, error = function(e) {
cat("‚ùå Error in:", file, "\n")
cat("   ‚Ü≥", conditionMessage(e), "\n\n")
})
}
} else {
warning("‚ö† Function folder not found: ", rFunc)
}
#----------------------------------------
# Logging
#----------------------------------------
log_status <- function(msg) {
log_file <- file.path(output, "copy_log.txt")
write(paste(Sys.time(), "-", msg), file = log_file, append = TRUE)
}
#----------------------------------------
# Profile Loaded Flag
#----------------------------------------
# this is used to state that the profile has been loaded correctly
# if the profile has been loaded correctly, the value of the variable
# profile_PROD-SDG-REP-2025 should be TRUE
# this macro is used as a check in other scripts
profile_PROD_SDG_REP_2025 = TRUE
message("‚úÖ Profile_PROD-SDG-REP-2025 loaded successfully.")
#----------------------------------------
# Example Usage
#----------------------------------------
# df <- data.frame(id = 1:3, value = c("A", "B", "C"))
# output_file <- file.path(output, "example_output.csv")
# write.csv(df, output_file, row.names = FALSE)
# copy_output_to_teams(output_file)
#-------------------------------------------------------------------
# Script: run_PROD-SDG-REP-2025.R
# Project: SDG Report 2025
# Sector: UNICEF Education Data & Analytics
# Purpose: Main script to execute 012_run.R and 022_run.R with logging
# Author: Garen Avanesian (refactored by Joao Pedro Azevedo)
# Date: Updated: 2025-06-12
#-------------------------------------------------------------------
# Ensure project profile is loaded
if (!exists("profile_PROD_SDG_REP_2025")) {
stop("‚ùå Please run 'profile_PROD-SDG-REP-2025.R' in the root directory before executing this script.")
}
# Define log directory and file
log_dir <- file.path("09_others", "091_logs")
dir.create(log_dir, showWarnings = FALSE, recursive = TRUE)
log_file <- file.path(log_dir, paste0("log_run_", format(Sys.time(), "%Y%m%d_%H%M%S"), ".txt"))
# Start logging
sink(log_file, append = TRUE, split = TRUE)
options(warn = 1)  # Print warnings immediately
cat("=========================================================\n")
cat("üü¶ SDG 2025 RUN LOG\n")
cat("Start time: ", format(Sys.time()), "\n")
cat("Log file: ", normalizePath(log_file, mustWork = FALSE), "\n")
cat("=========================================================\n\n")
#-------------------------------------------------------------------
# Execute wrapper scripts
#-------------------------------------------------------------------
script_012 <- file.path("01_data", "012_codes", "012_run.R")
script_022 <- file.path("02_benchmarking", "022_codes", "022_run.R")
run_with_log(script_012, "012_run")
run_with_log(script_022, "022_run")
#-------------------------------------------------------------------
# Final log and cleanup
#-------------------------------------------------------------------
cat("\n=========================================================\n")
cat("‚úÖ SDG 2025 Run completed at: ", format(Sys.time()), "\n")
cat("=========================================================\n")
sink()  # Stop logging
#-------------------------------------------------------------------
# Project: SDG Report 2025
# Script: R Profile Setup with Enhanced Environment Checks
# Purpose: Sets user-specific paths, verifies folder structure,
#          checks environment health, and loads all required packages.
# Authors: Joao Pedro Azevedo, Garen Avanesian
# Updated: 02 June 2025
#-------------------------------------------------------------------
set.seed(12345)
USERNAME     <- Sys.getenv("USERNAME")
USERPROFILE  <- Sys.getenv("USERPROFILE")
USER         <- Sys.getenv("USER")
# Make a wrapper to make sure USERNAME is not empty and works for Mac users
if (USERNAME == "" || is.na(USERNAME)) {
USERNAME <- Sys.getenv("USER")
}
# This is needed to make sure the userprofile argumewnt works on Mac
if (USERPROFILE == "" || is.na(USERPROFILE)) {
USERPROFILE <- "~"
}
copy_to_teams <- FALSE
create_missing_folders <- FALSE
#----------------------------------------
# Repository Name and Network Drive Check
#----------------------------------------
repo_name <- "PROD-SDG-REP-2025"  # This should match the GitHub repo folder name
network_root <- "Z:/"  # Adjust if your shared drive has a different root
network_root <- "Z:/"
if (!dir.exists(network_root)) {
warning(paste0(
"‚ö†Ô∏è Network drive not mounted (Z:/).\n",
"‚û§ The shared UNICEF DAPM-CSO storage appears to be unavailable.\n",
"   This may prevent access to critical scripts, inputs, or outputs.\n\n",
"üìå To resolve:\n",
"1. Ensure you are using a UNICEF-issued laptop or desktop.\n",
"2. Confirm that you have been granted access to the shared storage.\n",
"   - Temporarily, email Daniele Dolivotti (dolivotti@unicef.org).\n",
"3. Map the network drive:\n",
"   - Open File Explorer > Click '...' > Map Network Drive.\n",
"   - Use 'Z:' as the drive letter.\n",
"   - Folder: \\\\saunicorezus1nyhqdapmcso.file.core.windows.net\\dapm-cso\n",
"   - Enable 'Reconnect at sign-in'.\n\n",
"üîÅ Re-run the script once the drive is properly mounted."
))
}
#----------------------------------------
# Load User Config (YAML Required)
#----------------------------------------
config_path <- file.path(USERPROFILE, ".config", "user_config.yml")
# Ensure YAML package is available
if (!requireNamespace("yaml", quietly = TRUE)) install.packages("yaml")
library(yaml)
# Check if config file exists
if (!file.exists(config_path)) {
stop(paste0(
"‚ùå Configuration file not found at expected path: ", config_path, "\n",
"üëâ Please create or move your 'user_config.yml' to this location.\n",
"A template is available in the GitHub repository under: '_config_template/user_config.yml'"
))
}
# Read config
config_yaml <- yaml::read_yaml(config_path)
# Validate user entry
if (!USERNAME %in% names(config_yaml)) {
stop(paste0(
"‚ùå Configuration file found at: ", config_path, ",\n",
"but no entry found for user: '", USERNAME, "'.\n",
"üëâ Please ensure your username is correctly defined in the YAML file.\n",
"A template is available in the GitHub repo under: '_config_template/user_config.yml'."
))
}
# Load user-specific paths
githubFolder <- config_yaml[[USERNAME]]$githubFolder
teamsRoot    <- config_yaml[[USERNAME]]$teamsRoot
# Confirm successful load
message(paste0("‚úÖ Loaded user configuration for '", USERNAME, "' from: ", config_path))
# Define full paths using repo_name
projectFolder <- file.path(githubFolder, repo_name)
# Check that the last folder in githubFolder matches the repo name
actual_repo_folder <- basename(normalizePath(projectFolder, winslash = "/", mustWork = FALSE))
if (!identical(actual_repo_folder, repo_name)) {
stop(sprintf("‚ùå The repo_name '%s' does not match the actual folder name '%s' in githubFolder.", repo_name, actual_repo_folder))
}
teamsFolder   <- file.path(teamsRoot, "022.SDG-Report-2025")
#----------------------------------------
# Directory Structure
# üìÅ Documentation
doc         <- file.path(projectFolder, "00_documentation")
docInput    <- file.path(doc, "01_input_data")
docProc     <- file.path(doc, "02_processed_data")
# üìÅ Input Data
metaData        <- file.path(projectFolder, "01_data_prep/011_rawdata/hosted_in_repo")
metaDataUpdate  <- file.path(projectFolder, "01_data_prep/011_rawdata/")
targetData      <- file.path(projectFolder, "01_data_prep/011_rawdata/hosted_in_repo")
rawData         <- file.path(projectFolder, "01_data_prep/011_rawdata/")
procData        <- file.path(projectFolder, "01_data_prep/013_wrkdata/")
# üìÅ Functions
rFunc       <- file.path(projectFolder, "99_functions")
# üìÅ Teams
teamsFigures <- file.path(teamsFolder, "figures")
# üìÅ Data Analysis and Visualization
dataAnalytics        <- file.path(projectFolder, "03_data_analytics")
dataVizFigures       <- file.path(dataAnalytics, "033_results/figures")
# üìÅ Country Briefs
countryBriefs    <- file.path(projectFolder, "04_country_briefs")
GraphFolder      <- file.path(countryBriefs, "043_interim_output/graphs")
TemplateFolder   <- file.path(countryBriefs, "042_codes/md_template")
IntOutputFolder  <- file.path(countryBriefs, "043_interim_output/raw_output")
project_dirs <- c(doc, docInput, docProc, rFunc, metaData, targetData, rawData, procData, metaDataUpdate,
dataAnalytics, dataVizFigures, countryBriefs)
teams_dirs   <- c(teamsFigures)
required_dirs <- c(project_dirs, teams_dirs)
for (dir in required_dirs) {
if (!dir.exists(dir)) {
if (create_missing_folders) {
message(sprintf("üìÅ Creating missing folder: %s", dir))
dir.create(dir, recursive = TRUE)
} else {
stop(sprintf("‚ùå Required folder not found: %s. Set create_missing_folders <- TRUE to auto-create.", dir))
}
}
}
#----------------------------------------
# Environment Health Check
#----------------------------------------
check_env <- function() {
message("üîç Environment Check:")
message("- User: ", USERNAME)
message("- Project folder exists: ", dir.exists(projectFolder))
message("- Output folder writeable: ", file.access(procData, 2) == 0)
message("- Network drive available: ", dir.exists(network_root))
message("- R version: ", getRversion())
}
check_env()
#----------------------------------------
# Package Handling
#----------------------------------------
required_packages <- c(
"readr", "tidyverse", "data.table", "countrycode", "wesanderson",
"readxl", "openxlsx", "ggcorrplot", "gridExtra", "utf8", "haven",
"plotly", "mgcv", "DT", "sass", "devtools", "Rilostat", "wbstats",
"zoo", "cowplot", "MatchIt", "GGally", "COINr"
)
check_and_install_packages <- function(packages) {
install_type <- ifelse(.Platform$OS.type == "windows", "binary", "source")
for (pkg in unique(packages)) {
if (!requireNamespace(pkg, quietly = TRUE)) {
message(sprintf("üì¶ Installing missing package: %s", pkg))
install.packages(pkg, type = install_type)
}
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}
}
check_and_install_packages(required_packages)
message("‚úÖ All required libraries were loaded successfully.")
#----------------------------------------
# Source Utility Functions
#----------------------------------------
if (dir.exists(rFunc)) {
r_func_files <- list.files(path = rFunc, pattern = "\\.R$", full.names = TRUE)
for (file in r_func_files) {
cat("üîÑ Sourcing:", file, "\n")
tryCatch({
source(file)
}, error = function(e) {
cat("‚ùå Error in:", file, "\n")
cat("   ‚Ü≥", conditionMessage(e), "\n\n")
})
}
} else {
warning("‚ö† Function folder not found: ", rFunc)
}
#----------------------------------------
# Logging
#----------------------------------------
log_status <- function(msg) {
log_file <- file.path(output, "copy_log.txt")
write(paste(Sys.time(), "-", msg), file = log_file, append = TRUE)
}
#----------------------------------------
# Profile Loaded Flag
#----------------------------------------
# this is used to state that the profile has been loaded correctly
# if the profile has been loaded correctly, the value of the variable
# profile_PROD-SDG-REP-2025 should be TRUE
# this macro is used as a check in other scripts
profile_PROD_SDG_REP_2025 = TRUE
message("‚úÖ Profile_PROD-SDG-REP-2025 loaded successfully.")
#----------------------------------------
# Example Usage
#----------------------------------------
# df <- data.frame(id = 1:3, value = c("A", "B", "C"))
# output_file <- file.path(output, "example_output.csv")
# write.csv(df, output_file, row.names = FALSE)
# copy_output_to_teams(output_file)
#-------------------------------------------------------------------
# Script: run_PROD-SDG-REP-2025.R
# Project: SDG Report 2025
# Sector: UNICEF Education Data & Analytics
# Purpose: Main script to execute 012_run.R and 022_run.R with logging
# Author: Garen Avanesian (refactored by Joao Pedro Azevedo)
# Date: Updated: 2025-06-12
#-------------------------------------------------------------------
# Ensure project profile is loaded
if (!exists("profile_PROD_SDG_REP_2025")) {
stop("‚ùå Please run 'profile_PROD-SDG-REP-2025.R' in the root directory before executing this script.")
}
# Define log directory and file
log_dir <- file.path("09_others", "091_logs")
dir.create(log_dir, showWarnings = FALSE, recursive = TRUE)
log_file <- file.path(log_dir, paste0("log_run_", format(Sys.time(), "%Y%m%d_%H%M%S"), ".txt"))
# Start logging
sink(log_file, append = TRUE, split = TRUE)
options(warn = 1)  # Print warnings immediately
cat("=========================================================\n")
cat("üü¶ SDG 2025 RUN LOG\n")
cat("Start time: ", format(Sys.time()), "\n")
cat("Log file: ", normalizePath(log_file, mustWork = FALSE), "\n")
cat("=========================================================\n\n")
#-------------------------------------------------------------------
# Execute wrapper scripts
#-------------------------------------------------------------------
script_012 <- file.path("01_data", "012_codes", "012_run.R")
script_022 <- file.path("02_benchmarking", "022_codes", "022_run.R")
run_with_log(script_012, "012_run")
run_with_log(script_022, "022_run")
#-------------------------------------------------------------------
# Final log and cleanup
#-------------------------------------------------------------------
cat("\n=========================================================\n")
cat("‚úÖ SDG 2025 Run completed at: ", format(Sys.time()), "\n")
cat("=========================================================\n")
sink()  # Stop logging
#-------------------------------------------------------------------#
# Purpose: Run selected scripts TASK 01
# Main Script: 012_run.R
# Author: Joao Pedro Azevedo
# Date: 2025-06-12
#-------------------------------------------------------------------#
# File: 012_run.R
# Description: This script allows the user to run a series of predefined R scripts
#              related to the SDG Report 2025 project. It provides options to run all scripts,
#              select specific scripts by index, or by name. The scripts are sourced from a
#              specified directory, and the user can easily modify which scripts to run.
#-------------------------------------------------------------------#
# Define base path
base_path <- file.path(projectFolder,"01_data_prep", "012_codes")
# Available scripts
available_scripts <- c(
"0120_create_country_metadata.R",
"0121_get_data_api.R",
"0122_create_target_master.R",
"0123_create_data.R",
"0124_rank_data.R",
"0127_create_iData_codebook.R"
)
# ---- OPTION TO SELECT SCRIPTS ----
# Option 1: Run all (default)
# scripts_to_run <- available_scripts
# Option 2: Uncomment to manually select scripts by index
selected_indices <- c(1, 2, 3, 4, 5)
scripts_to_run <- available_scripts[selected_indices]
# Option 3: Uncomment to manually select scripts by name
# scripts_to_run <- c(
#   "0120_create_country_metadata.R",
#   "0123_create_data.R"
# )
# ---- EXECUTION ----
if (length(scripts_to_run) == 0) {
stop("‚ö† No scripts selected to run.")
}
for (script in scripts_to_run) {
full_path <- file.path(base_path, script)
if (!file.exists(full_path)) {
warning("‚ö† File not found: ", script)
next
}
message("\n--- Running: ", script, " ---")
source(full_path, echo = TRUE, print.eval = TRUE)
message("‚úì Completed: ", script)
}
message("\n‚úÖ Selected tasks 01 completed successfully in 012_run.R")
# ---- END OF SCRIPT ----
# Note: Ensure that the scripts in the 012_run folder are ready
# Purpose: Run selected scripts TASK 02
# Main Script: 012_run.R
# Author: Joao Pedro Azevedo
# Date: 2025-06-12
# Define base path
base_path <- file.path(projectFolder,"02_benchmarking", "022_codes")
# Available scripts
available_scripts <- c(
"0221_benchmark_data.R",
"0222_bench_reg_inc.R",
"0223_create_iData_codebook.R",
"0224_create_iData_webpage.R",
"0225_projections.R"
)
# ---- OPTION TO SELECT SCRIPTS ----
# Option 1: Run all (default)
# scripts_to_run <- available_scripts
# Option 2: Uncomment to manually select scripts by index
selected_indices <- c(1, 2, 3, 4, 5)
scripts_to_run <- available_scripts[selected_indices]
# Option 3: Uncomment to manually select scripts by name
# scripts_to_run <- c(
#   "0222_bench_reg_inc.R",
#   "0224_projections.R"
# )
# ---- EXECUTION ----
if (length(scripts_to_run) == 0) {
stop("‚ö† No scripts selected to run.")
}
for (script in scripts_to_run) {
full_path <- file.path(base_path, script)
if (!file.exists(full_path)) {
warning("‚ö† File not found: ", script)
next
}
message("\n--- Running: ", script, " ---")
source(full_path, echo = TRUE, print.eval = TRUE)
message("‚úì Completed: ", script)
}
