name: Sync to UNICEF-DRP

on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove private content
        run: |
          # Private folders
          rm -rf paper/
          rm -rf drafts/
          rm -rf internal/
          rm -rf benchmarks/
          rm -rf _drafts/
          rm -rf eb1a/
          
          # Execution artifacts (keep test code public, exclude logs/results)
          rm -rf tests/logs/
          rm -rf qa/logs/
          rm -rf validation/results/
          
          # General log files
          find . -type f -name "*.log" -delete
          
          # Private GitHub config
          rm -f .github/copilot-instructions.md
          rm -rf .github/copilot/
          rm -rf .github/prompts/
          
          # Hide sync workflow (contains private repo name)
          rm -f .github/workflows/sync-to-public.yml
          
          # Remove any other private files
          rm -f PRIVATE_NOTES.md
          rm -f TODO-internal.md

      - name: Push to UNICEF-DRP (stage branch)
        uses: cpina/github-action-push-to-another-repository@main
        env:
          SSH_DEPLOY_KEY: ${{ secrets.UNICEF_DRP_DEPLOY_KEY }}
        with:
          source-directory: '.'
          destination-github-username: 'unicef-drp'
          destination-repository-name: 'unicefData'
          target-branch: stage
          user-name: 'github-actions[bot]'
          user-email: 'github-actions[bot]@users.noreply.github.com'

      - name: Create pull request to main
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            // Note: This creates a PR in the -dev repo
            // You'll need to manually create PR in unicefData repo via GitHub UI
            console.log('‚úÖ Sync complete to stage branch');
            console.log('üìç Next: Review changes at https://github.com/unicef-drp/unicefData/tree/stage');
            console.log('üîÑ Then: Create pull request from stage ‚Üí main in unicefData repo')
