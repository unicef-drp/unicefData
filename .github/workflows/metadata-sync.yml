name: Weekly Metadata Refresh

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  refresh-metadata:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          pip install requests pyyaml
      
      - name: Build dataflow dimension values
        run: |
          cd stata/src/py
          python build_dataflow_metadata.py \
            --outdir ../_/ \
            --agency UNICEF \
            --verbose
        continue-on-error: false
      
      - name: Enrich indicators with dimension values
        run: |
          cd stata/src/py
          
          # Check if enrich script exists
          if [ -f "enrich_indicators_metadata.py" ]; then
            python enrich_indicators_metadata.py \
              --dataflow-metadata ../_/_unicefdata_dataflow_metadata.yaml \
              --indicator-metadata ../_/_unicefdata_indicators_metadata.yaml \
              --output ../_/_unicefdata_indicators_metadata.yaml \
              --verbose
          else
            echo "⚠ enrich_indicators_metadata.py not found - skipping dimension enrichment"
          fi
        continue-on-error: true
      
      - name: Update sync history
        run: |
          # Create/update sync history entry with current timestamp
          DATE=$(date -u +"%Y-%m-%d")
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          cat > stata/src/_/_unicefdata_sync_history.yaml << EOF
          vintages:
          - vintage_date: '$DATE'
            synced_at: '$TIMESTAMP'
            
            # Auto-generated by GitHub Actions workflow
            dataflows: $(grep -c "^  [A-Z]" stata/src/_/_unicefdata_dataflows.yaml || echo 0)
            indicators: 0
            codelists: 0
            countries: 0
            regions: 0
            
            # Dataflow dimension values
            dataflow_metadata_synced: true
            dataflow_metadata_timestamp: '$TIMESTAMP'
            
            # Indicator enrichment
            indicator_enrichment_synced: true
            indicator_enrichment_timestamp: '$TIMESTAMP'
            
            errors: []
            warnings: []
            
            note: 'Auto-generated by GitHub Actions weekly refresh'
          EOF
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code stata/src/_/_unicefdata_*.yaml || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add stata/src/_/_unicefdata_dataflow_metadata.yaml
          git add stata/src/_/_unicefdata_indicators_metadata.yaml
          git add stata/src/_/_unicefdata_sync_history.yaml
          
          git commit -m "chore: weekly metadata refresh [skip ci]

          - Updated dataflow dimension values
          - Enriched indicator metadata with dimension values
          - Auto-generated by GitHub Actions workflow
          
          Workflow: .github/workflows/metadata-sync.yml
          Triggered: ${{ github.event_name }}"
          
          git push
      
      - name: Create issue if failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠ Weekly metadata refresh failed',
              body: `
              ## Metadata Refresh Failure
              
              The automated metadata refresh workflow failed.
              
              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              
              **Triggered by:** ${{ github.event_name }}
              
              **Timestamp:** ${{ github.event.head_commit.timestamp }}
              
              ### Troubleshooting Steps
              
              1. Check the workflow logs for error details
              2. Verify UNICEF SDMX API is accessible
              3. Check Python dependencies (requests, pyyaml)
              4. Review recent commits for breaking changes
              5. Run \`unicefdata_refresh_all\` manually to reproduce
              
              ### Manual Recovery
              
              If automated refresh continues to fail:
              
              \`\`\`stata
              * Manual refresh from Stata
              unicefdata_refresh_all, verbose force
              \`\`\`
              
              \`\`\`bash
              # Manual refresh from command line
              cd stata/src/py
              python build_dataflow_metadata.py --outdir ../_/ --agency UNICEF --verbose
              \`\`\`
              `,
              labels: ['automation', 'metadata', 'bug']
            });
            
            console.log('Created issue:', issue.data.number);
      
      - name: Summary
        if: success()
        run: |
          echo "✓ Metadata refresh completed successfully"
          echo ""
          echo "Updated files:"
          echo "  - _unicefdata_dataflow_metadata.yaml"
          echo "  - _unicefdata_indicators_metadata.yaml"
          echo "  - _unicefdata_sync_history.yaml"
          echo ""
          echo "Next scheduled run: Monday 2:00 AM UTC"
