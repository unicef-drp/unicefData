name: Weekly Metadata Refresh

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  refresh-metadata:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          pip install requests pyyaml
      
      - name: Build dataflow dimension values
        timeout-minutes: 15
        run: |
          cd stata/src/py
          
          # Create output directory if needed
          mkdir -p ../_/
          
          # Run with retry on network failures
          max_attempts=3
          attempt=1
          until python build_dataflow_metadata.py \
            --outdir ../_/ \
            --agency UNICEF \
            --create-outdir \
            --verbose; do
            exit_code=$?
            if [ $attempt -ge $max_attempts ]; then
              echo "Failed after $max_attempts attempts"
              exit $exit_code
            fi
            echo "Attempt $attempt failed (exit code $exit_code), retrying in 30 seconds..."
            attempt=$((attempt + 1))
            sleep 30
          done
        continue-on-error: false
      
      - name: Enrich indicators with dimension values
        run: |
          cd stata/src/py
          
          # Check if enrich script exists
          if [ -f "enrich_indicators_metadata.py" ]; then
            python enrich_indicators_metadata.py \
              --dataflow-metadata ../_/_unicefdata_dataflow_metadata.yaml \
              --indicator-metadata ../_/_unicefdata_indicators_metadata.yaml \
              --output ../_/_unicefdata_indicators_metadata.yaml \
              --verbose
          else
            echo "⚠ enrich_indicators_metadata.py not found - skipping dimension enrichment"
          fi
        continue-on-error: true
      
      - name: Update sync history
        run: |
          # Create/update sync history entry with current timestamp
          DATE=$(date -u +"%Y-%m-%d")
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          cat > stata/src/_/_unicefdata_sync_history.yaml << EOF
          vintages:
          - vintage_date: '$DATE'
            synced_at: '$TIMESTAMP'
            
            # Auto-generated by GitHub Actions workflow
            dataflows: $(grep -c "^  [A-Z]" stata/src/_/_unicefdata_dataflows.yaml || echo 0)
            indicators: 0
            codelists: 0
            countries: 0
            regions: 0
            
            # Dataflow dimension values
            dataflow_metadata_synced: true
            dataflow_metadata_timestamp: '$TIMESTAMP'
            
            # Indicator enrichment
            indicator_enrichment_synced: true
            indicator_enrichment_timestamp: '$TIMESTAMP'
            
            errors: []
            warnings: []
            
            note: 'Auto-generated by GitHub Actions weekly refresh'
          EOF
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code stata/src/_/_unicefdata_*.yaml || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push to metadata-sync branch
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="metadata-sync"
          git checkout -B "$BRANCH"

          git add stata/src/_/_unicefdata_dataflow_metadata.yaml
          git add stata/src/_/_unicefdata_indicators_metadata.yaml
          git add stata/src/_/_unicefdata_sync_history.yaml

          git commit -m "chore: weekly metadata refresh $(date -u +%Y-%m-%d)

          - Updated dataflow dimension values
          - Enriched indicator metadata with dimension values
          - Auto-generated by GitHub Actions workflow

          Workflow: .github/workflows/metadata-sync.yml
          Triggered: ${{ github.event_name }}"

          git push --force-with-lease origin "$BRANCH"
        id: push-branch

      - name: Create or update pull request
        if: steps.git-check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = 'metadata-sync';
            const base = 'develop';

            // Check if a PR already exists for this branch
            const { data: prs } = await github.rest.pulls.list({
              owner, repo, head: `${owner}:${head}`, base, state: 'open'
            });

            if (prs.length > 0) {
              const pr = prs[0];
              const date = new Date().toISOString().split('T')[0];
              await github.rest.pulls.update({
                owner, repo, pull_number: pr.number,
                title: `chore: weekly metadata refresh (${date})`,
                body: [
                  '## Automated Metadata Refresh',
                  '',
                  `Updated: ${date}`,
                  '',
                  'UNICEF SDMX metadata files:',
                  '- `_unicefdata_dataflow_metadata.yaml`',
                  '- `_unicefdata_indicators_metadata.yaml`',
                  '- `_unicefdata_sync_history.yaml`',
                  '',
                  `Latest run: ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`,
                  '',
                  '---',
                  'Auto-generated by `.github/workflows/metadata-sync.yml`'
                ].join('\n')
              });
              console.log('Updated existing PR #' + pr.number);
            } else {
              const date = new Date().toISOString().split('T')[0];
              const pr = await github.rest.pulls.create({
                owner, repo,
                title: `chore: weekly metadata refresh (${date})`,
                head, base,
                body: [
                  '## Automated Metadata Refresh',
                  '',
                  `Updated: ${date}`,
                  '',
                  'UNICEF SDMX metadata files:',
                  '- `_unicefdata_dataflow_metadata.yaml`',
                  '- `_unicefdata_indicators_metadata.yaml`',
                  '- `_unicefdata_sync_history.yaml`',
                  '',
                  `Workflow run: ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`,
                  '',
                  '---',
                  'Auto-generated by `.github/workflows/metadata-sync.yml`'
                ].join('\n')
              });
              console.log('Created PR #' + pr.data.number + ': ' + pr.data.html_url);
            }
      
      - name: Create issue if failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠ Weekly metadata refresh failed',
              body: `
              ## Metadata Refresh Failure
              
              The automated metadata refresh workflow failed.
              
              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              
              **Triggered by:** ${{ github.event_name }}
              
              **Timestamp:** ${{ github.event.head_commit.timestamp }}
              
              ### Troubleshooting Steps
              
              1. Check the workflow logs for error details
              2. Verify UNICEF SDMX API is accessible
              3. Check Python dependencies (requests, pyyaml)
              4. Review recent commits for breaking changes
              5. Run \`unicefdata_refresh_all\` manually to reproduce
              
              ### Manual Recovery
              
              If automated refresh continues to fail:
              
              \`\`\`stata
              * Manual refresh from Stata
              unicefdata_refresh_all, verbose force
              \`\`\`
              
              \`\`\`bash
              # Manual refresh from command line
              cd stata/src/py
              python build_dataflow_metadata.py --outdir ../_/ --agency UNICEF --verbose
              \`\`\`
              `,
              labels: ['automation', 'metadata', 'bug']
            });
            
            console.log('Created issue:', issue.data.number);
      
      - name: Summary
        if: success()
        run: |
          echo "✓ Metadata refresh completed successfully"
          echo ""
          echo "Updated files:"
          echo "  - _unicefdata_dataflow_metadata.yaml"
          echo "  - _unicefdata_indicators_metadata.yaml"
          echo "  - _unicefdata_sync_history.yaml"
          echo ""
          echo "Next scheduled run: Monday 2:00 AM UTC"
