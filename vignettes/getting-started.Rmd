---
title: "Getting Started with unicefData"
author: "UNICEF Data Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with unicefData}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

The `unicefData` package provides easy access to UNICEF's data through the SDMX API. This vignette demonstrates four essential workflows:

1. **Search for indicator codes** - Find indicators by name or category
2. **Find the dataflow for an indicator** - Discover which dataflow contains your indicator
3. **Download a specific indicator** - Fetch data for one or more indicators
4. **Download an entire dataflow** - Get all indicators from a dataflow at once

```{r load_package, message=FALSE}
library(unicefData)
library(dplyr)
```

---

## 1. Search for Indicator Codes

UNICEF has over 700 indicators across various categories (Child Mortality, Nutrition, Education, etc.). The `search_indicators()` function helps you find the right indicator code.

### Search by keyword

```{r search_mortality, eval=FALSE}
# Search for mortality indicators
mortality_inds <- search_indicators("mortality")
```

### Search by category

```{r search_by_category, eval=FALSE}
# Get all child mortality indicators
cme_inds <- search_indicators(category = "CME")  # limit = 0 shows all
```

### Get detailed information about a specific indicator

```{r indicator_info}
# Get full metadata for under-five mortality rate
info <- get_indicator_info("CME_MRY0T4")
info
```

### List all available categories

```{r list_categories, eval=FALSE}
# See all indicator categories
list_categories()
```

---

## 2. Find the Dataflow for an Indicator

Each indicator belongs to a **dataflow** (a thematic dataset). The `get_dataflow_for_indicator()` function tells you which dataflow contains your indicator.

### Find dataflow for a specific indicator

```{r find_dataflow}
# Which dataflow contains under-five mortality?
dataflow <- get_dataflow_for_indicator("CME_MRY0T4")
dataflow
```

### Find dataflows for multiple indicators

```{r find_multiple_dataflows}
indicators <- c("CME_MRY0T4", "NT_ANT_HAZ_NE2", "ED_CR_L1_UIS_MOD")
dataflows <- sapply(indicators, get_dataflow_for_indicator)
data.frame(
  indicator = indicators,
  dataflow = dataflows
)
```

### List all available dataflows

```{r list_dataflows}
# See all dataflows in the UNICEF API
dataflows <- list_dataflows()
head(dataflows, 5)
```

**Note:** Most indicators can be auto-detected from their prefix (e.g., `CME_*` â†’ `CME` dataflow), but some have exceptions that are handled automatically.

---

## 3. Download a Specific Indicator

The `unicefData()` function fetches data for one or more indicators. By default, it returns clean, analysis-ready data with totals only.

### Basic usage: Single indicator

```{r download_single}

# Download the whole indicator, but without disaggragations (e.g. total sex only)
df1 <- unicefData(indicator = "CME_MRY0T4")
dim(df1)  # 15194 x 23

# Download the whole indicator, raw SDMX format
df_raw <- unicefData_raw(indicator = "CME_MRY0T4")
dim(df_raw) # 63070 x 19

# note that using `raw = TRUE` achieves similar results only revising a few
# column names: "iso3", "indicator", "period", "value", "country"
df_raw2 <- unicefData(indicator = "CME_MRY0T4", raw = TRUE)
dim(df_raw2) # 63070 x 20

# Raw is the same as using the datawarehouse download link
dt <- data.table::fread(
  "https://sdmx.data.unicef.org/ws/public/sdmxapi/rest/data/UNICEF,CME,1.0/.CME_MRY0T4..?format=csv&labels=both"
)
dim(dt)  # 63070 x 19

# Download for selected countries
df <- unicefData(
  indicator = "CME_MRY0T4",
  countries = c("AFG", "USA", "BRA", "IND", "NGA"),
  year = 2023
)

```

### Download multiple indicators at once

```{r download_multiple}
# Compare mortality rates
df <- unicefData(
  indicator = c("CME_MRY0T4", "CME_MRM0"),  # U5MR and infant mortality
  countries = c("USA", "IND", "NGA"),
  year = "2015:2024"
)

df %>%
  select(iso3, indicator, indicator_name, period, value) %>%
  arrange(iso3, indicator)
```

---

## 4. Download an Entire Dataflow

Instead of specifying individual indicators, you can download **all indicators** from a dataflow at once using `unicefData_dataflow()`.

### Download all indicators from CME dataflow

```{r download_dataflow, eval=FALSE}
# Get all child mortality indicators (CME dataflow)
df_subset <- unicefData(
  dataflow = "CME",
  year = 2020:2023
)

# Note: This may take a minute as it fetches the whole dataflow containing all
# segregation
df_all <- unicefData_raw(
  dataflow = "CME"
)

# get_sdmx(flow = "CME")
dim(df_all)  # 790460 x 20

# This is the same as 
# dt_all <- fread(
#   "https://sdmx.data.unicef.org/ws/public/sdmxapi/rest/data/UNICEF,CME,1.0/all?format=csv&labels=both"
# )
```


