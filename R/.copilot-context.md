# R Development Context for `unicefData`

This file provides R-specific guidance for AI coding agents working within the `R/` directory.

## R Environment Setup

- Use `unicefData.Rproj` to open the project in RStudio.
- **R Installation:**
  - Download R from https://cran.r-project.org/
  - **Windows:** Download the `.exe` installer from https://cran.r-project.org/bin/windows/base/
  - **macOS:** Download the `.pkg` installer from https://cran.r-project.org/bin/macosx/
  - **Linux (Ubuntu/Debian):**
    ```bash
    sudo apt update
    sudo apt install r-base r-base-dev
    ```
- **Current installation on this machine:**
  - **Path:** `C:\Program Files\R\R-4.5.1`
  - **Rscript:** `C:\Program Files\R\R-4.5.1\bin\Rscript.exe`
  - **Version:** R 4.5.1 (2025-06-13)
- **Add R to PATH** (required for command-line scripts):
  - **Windows:** Add `C:\Program Files\R\R-4.5.1\bin` to your system PATH environment variable
    - Or use full path: `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe"`
  - **macOS:** R installer usually adds to PATH; verify with `which Rscript`
    - Common paths: `/usr/local/bin/Rscript` or `/opt/homebrew/bin/Rscript`
  - **Linux:** Usually available after installation; verify with `which Rscript`
- **Verify installation:**
  ```bash
  Rscript --version
  # Should output: R scripting front-end version 4.x.x
  ```
- **Install required R packages** by running in R or RStudio:
  ```R
  install.packages(c("httr", "readr", "dplyr", "tibble", "xml2", "memoise", 
                     "countrycode", "yaml", "jsonlite", "magrittr", "purrr", 
                     "rlang", "digest", "tidyr", "devtools", "testthat"))
  ```
- **Install package in development mode:**
  ```R
  devtools::install(".")
  # Or load without installing:
  devtools::load_all(".")
  ```

## ⚠️ CRITICAL: R Package Documentation Workflow

When modifying R function signatures (adding, removing, or renaming parameters):

1. **ALWAYS regenerate documentation** after changing function parameters:
   ```R
   devtools::document()
   ```
   This updates the `.Rd` files in `man/` from roxygen2 comments in `R/*.R` files.

2. **R CMD check validates code/docs alignment** - CI will fail if:
   - Function signature in code differs from `\usage{}` in `.Rd` files
   - Parameters in code are missing from `@param` roxygen tags
   - Documented parameters don't exist in the function

3. **Cross-platform consistency** - When updating parameters, ensure alignment across:
   - R: `R/unicefData.R` (update function + roxygen comments, then `devtools::document()`)
   - Python: `python/unicef_api/core.py` (update function + docstrings)
   - Stata: `stata/src/u/unicefdata.ado` (update syntax + help file)

4. **Verify before committing:**
   ```R
   setwd('c:/GitHub/others/unicefData')
   devtools::document()
   devtools::check(args = c('--no-tests', '--no-vignettes', '--no-examples'))
   ```
   Expect: `0 errors ✔ | 0 warnings ✔`

## Running R Tests

Use `testthat` to run unit tests:
```R
library(testthat)
test_dir("tests")
```

## R Metadata Scripts

| Script | Function | Output Files |
|--------|----------|--------------|
| `metadata_sync.R` | Fetches core metadata (dataflows, codelists, countries, regions, indicators) | `_unicefdata_*.yaml` (5 files) |
| `schema_sync.R` | Fetches dataflow DSDs, samples data for dimension values | `dataflow_index.yaml`, `dataflows/*.yaml` |
| `indicator_registry.R` | Fetches `CL_UNICEF_INDICATOR` codelist, caches with 30-day staleness | `unicef_indicators_metadata.yaml` |

**Key functions:**
```r
# metadata_sync.R
sync_all_metadata(verbose = TRUE, output_dir = "R/metadata/current")

# schema_sync.R
sync_dataflow_schemas(verbose = TRUE, output_dir = "R/metadata/current")

# indicator_registry.R
refresh_indicator_cache()  # Force refresh from API
get_dataflow_for_indicator(code)  # Lookup with override table
get_cache_info()  # Check cache status
```

## R Metadata Directory Structure

```
R/
├── metadata/current/           # R-generated metadata
│   ├── _unicefdata_*.yaml      # Core metadata (5 files)
│   ├── unicef_indicators_metadata.yaml  # Full indicator codelist
│   ├── dataflow_index.yaml     # Dataflow summary
│   └── dataflows/*.yaml        # Individual dataflow schemas
```
